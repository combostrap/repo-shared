#!/usr/bin/env bash

# Strict Bash
set -TCEeuo pipefail

echo ""

###################
# Common function
###################
function rm_echo_yellow(){
    YELLOW="\033[0;33m"
    NO_COLOR="\033[0m"
    echo -e "${YELLOW}$1$NO_COLOR"
}

###################
# Project Env
# Project Environment are common project variables used in script
###################
# Project Root
export ORGANISATION_NAME="combostrap"
# Name used in env
export ORGANISATION_ENV_NAME="COMBOSTRAP"
# Name used in path
export ORGANISATION_PATH_NAME="combostrap"
# Used by script to get the root
export PROJECT_ROOT="$PWD"

# Feedback
echo "Project: "
echo "   PROJECT_ROOT              : $PROJECT_ROOT"
echo "   ORGANISATION_NAME         : ${ORGANISATION_NAME}"


# Install pre-commit hooks
if command -v pre-commit &> /dev/null; then

  echo ""
  echo "Pre-commit:"
  if [ ! -f "$PROJECT_ROOT/.git/hooks/pre-commit" ]; then
      pre-commit install
      echo "   Pre-commit hooks installed"
  else
      echo "   Pre-commit hooks enabled"
  fi
  if [ ! -f "$PROJECT_ROOT/.git/hooks/commit-msg" ]; then
      pre-commit install --hook-type commit-msg
      echo "   Commit-msg hooks installed"
  else
      echo "   Commit-msg hooks enabled"
  fi

else
    echo "⚠️ pre-commit not found. Install with: pip install pre-commit"
    exit 1
fi


#################
# Bin script installation
# The installation is done by cloning the repo to a well-known location.
#################
export RM_PREFIX="RM"
RM_DIR_VAR_NAME="${RM_PREFIX}${ORGANISATION_ENV_NAME}_DIR"
export RM_DIR
RM_DIR=$(realpath "${!RM_DIR_VAR_NAME:-$PWD/../repo-manager}")
if [ ! -d "$RM_DIR" ]; then

    RM_REPO_URI_VAR_NAME="${RM_PREFIX}${ORGANISATION_ENV_NAME}_URI"
    RM_REPO_URI="${!RM_REPO_URI_VAR_NAME:-https://github.com/combostrap/repo-manager}"
    rm_echo_yellow "Clone $RM_REPO_URI to $RM_DIR? Y(Yes-Default)/N(No)"
    read -r CLONE
    if [ "$CLONE" == "" ] || [ "$CLONE" == "Y" ]; then
        git clone "$RM_REPO_URI" "$RM_DIR"
        rm_echo_yellow "Repo Manager repo cloned"
    fi

fi

# Exit if the repo was not installed
if [ -d "$RM_DIR" ]; then

    #################
    # RM
    #################
    echo ""
    echo "Repo manager: "
    echo "   RM_DIR : $RM_DIR"

    #################
    # Bin
    #################
    BIN_PATH="$RM_DIR/bin"
    export PATH="$BIN_PATH:$PATH" # bin path first as it has a higher priority
    echo "   Scripts Path      : $BIN_PATH"

    echo ""
    echo "Git: "
    # Git user config to set the user email and name.
    git-config-user

fi

##############################
# Load sub envrc project script
##############################
ENVRCD="$PROJECT_ROOT/.envrc.d"
echo ""
echo "Envrc.d: "
if [ -d ENVRCD ]; then
  # All file loaded in a directory should have a sh extension
  # This is how /etc/profile also work
  for file in "$ENVRCD"/*.sh; do
    # shellcheck disable=SC1090
    if [ -r "$file" ]; then
      source "$file"
      echo "   executed $file"
    fi
  done
  unset file
else
  echo "   Not found"
fi

# Last EOL before direnv output
echo ""
